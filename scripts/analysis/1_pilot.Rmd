---
title: "pilot"
output:
  pdf_document: default
  html_document:
df_print: paged
header-includes:
 \usepackage{booktabs}
 \usepackage{longtable}
 \usepackage{array}
 \usepackage{multirow}
 \usepackage{wrapfig}
 \usepackage{float}
 \floatplacement{figure}{H}

---

# Pilot

```{r global-options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H', 
                      echo=TRUE, warning=FALSE, message=FALSE)
knitr::opts_knit$set(root.dir = '~/output/experiments/')

```



```{r includes}
library(tidyverse)
library(estimatr)
library(ggplot2)
library(readr)



# th <- theme_classic() +
#   theme(axis.text = element_text(size=26)) +
#   theme(axis.title = element_text(size=30)) 
# theme_set(th)

# update_geom_defaults("point", list(size = 10))
```

```{r load}

exp_name = "1_exit_22x40_doors"

parsed_trials <- read_csv("~/output/experiments/1_exit_22x40_doors/parsed_trials.csv") %>%
    mutate(resp_same = Response == "j",
         correct = !xor(base, resp_same)) %>%
  # trying to remove extra responses at the end
  group_by(ID, TrialOrder) %>%
  filter(row_number() == 1) %>%
  ungroup()

# 8 per row
gaps = c(TRUE, FALSE, TRUE, TRUE, TRUE, FALSE, FALSE, FALSE,
         TRUE, TRUE,  TRUE, TRUE, TRUE, FALSE, FALSE, TRUE, 
         FALSE, FALSE, TRUE, FALSE, FALSE, TRUE, FALSE, FALSE,
         FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, FALSE, TRUE)

gaps <- data.frame(scene = 1:32,
                   gap = gaps)

exp_data <- read_csv("~/output/scenes/1_exit_22x40_doors.csv") %>%
  rename(scene = id) %>%
  left_join(gaps, by = c("scene"))


```
```{r}
by_subj <- parsed_trials %>%
  group_by(ID)

hr_by_subj <- by_subj %>%
  filter(!base) %>%
  summarise(hr = mean(correct),
            n = n())

fp_by_subj <- by_subj %>%
  filter(base) %>%
  summarise(fp = 1.0 - mean(correct))

subject_performance <- hr_by_subj %>%
  left_join(fp_by_subj, by = "ID") %>%
  mutate(d_hr_fr = hr - fp)

# passed_subjects <- subject_performance
passed_subjects <- subject_performance %>%
  # filter(hr >= 1.75 * fp)
  filter(hr > 2.0 * fp, n == 64)
  # filter(n == 64)

good_data <- passed_subjects %>%
  left_join(parsed_trials)
```
```{r}
good_data %>%
  group_by(ID) %>%
  summarise(n = n())
```

# ```{r} 
# 
# raw_hits <- parsed_trials %>%
#   filter(!base) %>%
#   group_by(scene, door) %>%
#   summarise(c = sum(correct),
#             n = n()) %>%
#   left_join(exp_data)
# 
# raw_hits %>%
#   group_by(d > 0) %>%
#   summarise(c = sum(c))
# 
# raw_hits %>%
#   group_by(flip, d > 0) %>%
#   summarise(c = sum(c),
#             n = n())
# 
# raw_hits %>%
#   group_by(scene, door, d > 0) %>%
#   summarise(c = sum(c)) %>%
#   group_by(scene) %>%
#   summarise(dc = diff(c)) %>%
#   # filter(dc != 0) %>%
#   ggplot(aes(dc)) + 
#   geom_histogram()
# 
# ```


```{r} 

passed_hits <- good_data %>%
  filter(!base) %>%
  group_by(scene, door) %>%
  summarise(c = sum(correct),
            n = n(),
            f = c / n) %>%
  left_join(exp_data)


passed_hits %>%
  group_by(gap, door, d > 0) %>%
  summarise(c = sum(c),
            f = mean(f))


passed_hits %>%
 group_by(scene, d > 0) %>%
 summarise(c = sum(c),
           f = mean(f)) %>%
  group_by(scene) %>%
  summarise(dc = diff(c),
            df = diff(f)) %>%
  ggplot(aes(df)) + 
  geom_histogram()


hr_by_door <- passed_hits %>%
  group_by(scene) %>%
  summarise(f = mean(f)) %>%
  # filter(f <= 0.60) %>%
  select(scene) %>%
  left_join(passed_hits) %>%
  group_by(door, d > 0) %>%
  summarise(c = sum(c),
            f = mean(f))
 
delta_hr_by_scene <- passed_hits %>%
  group_by(scene) %>%
  summarise(f = mean(f)) %>%
  # filter(f <= 0.60) %>%
  select(scene) %>%
  left_join(passed_hits) %>%
  group_by(scene, d > 0) %>%
  summarise(c = sum(c),
            f = mean(f),
            n = n * n(),
            d = d,
            g = first(gap)) %>%
  group_by(scene) %>%
  summarise(dc = diff(c),
            df = diff(f),
            maxf = max(f),
            muf = mean(f),
            n = sum(n),
            d = max(d),
            g = first(g))

delta_hr_by_scene %>%
  ggplot(aes(x = d, y = df)) +
  geom_density2d_filled()


```

```{r}
passed_hits %>%
 ggplot(aes(x = d > 0, y = f)) + 
 geom_boxplot()
```

```{r}
model <- t.test(delta_hr_by_scene$df)
model
```


```{r}
model <- good_data %>%
  filter(!base) %>%
  left_join(exp_data, by = c("scene", "door")) %>%
  with(lm(correct ~ d > 0))
model %>%
  summary()
```

```{r}
model <- passed_hits %>%
  with(lm(f ~ (d > 0) + gap))
model %>%
  summary()
```


```{r}
model <-  good_data %>%
  left_join(exp_data, by = c("scene", "door")) %>%
  filter(d > 0, !base) %>%
  with(lm(correct ~ d + gap))
model %>%
  summary()
```




