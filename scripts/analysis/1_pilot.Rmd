---
title: "pilot"
output:
  pdf_document: default
  html_document:
df_print: paged
header-includes:
 \usepackage{booktabs}
 \usepackage{longtable}
 \usepackage{array}
 \usepackage{multirow}
 \usepackage{wrapfig}
 \usepackage{float}
 \floatplacement{figure}{H}

---

# Pilot

```{r global-options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H', 
                      echo=TRUE, warning=FALSE, message=FALSE)
knitr::opts_knit$set(root.dir = '~/output/experiments/')

```



```{r includes}
library(tidyverse)
library(estimatr)
library(ggplot2)
library(readr)



th <- theme_classic() +
  theme(axis.text = element_text(size=26)) +
  theme(axis.title = element_text(size=30)) 
theme_set(th)

update_geom_defaults("point", list(size = 10))
```

```{r load}

exp_name = "1_exit_22x40_doors"

parsed_trials <- read_csv("~/output/experiments/1_exit_22x40_doors/parsed_trials.csv") %>%
    mutate(resp_same = Response == "j",
         correct = !xor(base, resp_same))

exp_data <- read_csv("~/output/scenes/1_exit_22x40_doors.csv") %>%
  rename(scene = id)

# covariates <- read_csv("~/output/experiments/1_exit_22x40/covariates.csv")  %>%
#   rename(scene = id) %>%
#   mutate(zogd = scale(ogd),
#          zpixeld = scale(pixeld),
#          dsens = move_sense - base_sense)
# 
# features <- read_csv("~/output/experiments/1_exit_22x40/features.csv")  %>%
#   rename(scene = id)

```
```{r}
by_subj <- parsed_trials %>%
  group_by(ID)

hr_by_subj <- by_subj %>%
  filter(!base) %>%
  summarise(hr = mean(correct),
            n = n())

fp_by_subj <- by_subj %>%
  filter(base) %>%
  summarise(fp = 1.0 - mean(correct))

subject_performance <- hr_by_subj %>%
  left_join(fp_by_subj, by = "ID")

# passed_subjects <- subject_performance
passed_subjects <- subject_performance %>%
  filter(fp < 0.2, n == 64)

good_data <- passed_subjects %>%
  left_join(parsed_trials)
```
```{r}
good_data %>%
  group_by(ID) %>%
  summarise(n = n())
```

# ```{r} 
# 
# raw_hits <- parsed_trials %>%
#   filter(!base) %>%
#   group_by(scene, door) %>%
#   summarise(c = sum(correct),
#             n = n()) %>%
#   left_join(exp_data)
# 
# raw_hits %>%
#   group_by(d > 0) %>%
#   summarise(c = sum(c))
# 
# raw_hits %>%
#   group_by(flip, d > 0) %>%
#   summarise(c = sum(c),
#             n = n())
# 
# raw_hits %>%
#   group_by(scene, door, d > 0) %>%
#   summarise(c = sum(c)) %>%
#   group_by(scene) %>%
#   summarise(dc = diff(c)) %>%
#   # filter(dc != 0) %>%
#   ggplot(aes(dc)) + 
#   geom_histogram()
# 
# ```


```{r} 

passed_hits <- good_data %>%
  filter(!base) %>%
  group_by(scene, door) %>%
  summarise(c = sum(correct),
            n = n(),
            f = c / n) %>%
  left_join(exp_data)


passed_hits %>%
  group_by(door, d > 0) %>%
  summarise(c = sum(c),
            f = mean(f))


passed_hits %>%
  group_by(scene, d > 0) %>%
  summarise(c = sum(c),
            f = mean(f)) %>%
  group_by(scene) %>%
  summarise(dc = diff(c),
            df = diff(f))

passed_hits %>%
 group_by(scene, d > 0) %>%
 summarise(c = sum(c),
           f = mean(f)) %>%
  group_by(scene) %>%
  summarise(dc = diff(c),
            df = diff(f)) %>%
  ggplot(aes(df)) + 
  geom_histogram()


hr_by_door <- passed_hits %>%
  group_by(scene) %>%
  summarise(f = mean(f)) %>%
  filter(f < 0.5) %>%
  select(scene) %>%
  left_join(passed_hits) %>%
  group_by(door, d > 0) %>%
  summarise(c = sum(c),
            f = mean(f))
 
hr_by_door

delta_hr_by_scene <- passed_hits %>%
  group_by(scene) %>%
  summarise(f = mean(f)) %>%
  filter(f < 0.50) %>%
  select(scene) %>%
  left_join(passed_hits) %>%
  group_by(scene, d > 0) %>%
  summarise(c = sum(c),
            f = mean(f),
            n = n * n(),
            d = d) %>%
  group_by(scene) %>%
  summarise(dc = diff(c),
            df = diff(f),
            maxf = max(f),
            muf = mean(f),
            n = sum(n),
            d = max(d))

delta_hr_by_scene

delta_hr_by_scene %>%
  ggplot(aes(x = muf, y = df)) +
  geom_density2d_filled()


delta_hr_by_door <- delta_hr_by_scene %>%
  summarise(mu = mean(df),
            sd = sd(df),
            se = sd / sqrt(n * n()))
delta_hr_by_door

delta_hr_by_scene%>%
  ggplot(aes(df)) + 
  geom_histogram()

```

```{r}
passed_hits %>%
 ggplot(aes(x = d > 0, y = c)) + 
 geom_boxplot()
```


